<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Team Publications</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; }
    details summary { font-size: 1.5em; cursor: pointer; margin-top: 1em; background-color: #f0f0f0; padding: 5px; }
    details[open] summary { font-weight: bold; }
    h3 { margin-top: 1em; }
    li { margin-bottom: 0.8em; }
  </style>
</head>
<body>
  <h1>Our Research Publications</h1>
  <div id="publications"></div>

  <script>
    const orcids = [
      { id: "0000-0002-5022-6150", name: "Viktorija Makarovaite" },
      { id: "0000-0002-2373-6788", name: "Campbell W. Gourlay" },
      { id: "0000-0002-5139-5765", name: "John C. Batchelor" },
      { id: "0000-0001-8977-9257", name: "Simon J. Holder" },
    ];

    async function fetchPublications(orcid) {
      const response = await fetch(`https://pub.orcid.org/v3.0/${orcid.id}/works`, {
        headers: { Accept: "application/json" },
      });
      const data = await response.json();
      const works = data.group || [];

      return works.map(w => {
        const summary = w["work-summary"][0];
        const title = summary["title"]?.["title"]?.["value"] || "Untitled";
        const year = summary["publication-date"]?.year?.value || "n.d.";
        const type = summary["type"] || "other";

        const contributors = summary["contributors"]?.["contributor"] || [];
        const allAuthors = contributors
          .map(c => c["credit-name"]?.["value"])
          .filter(Boolean);

        const authorString = allAuthors.length > 1
          ? `${allAuthors[0]} et al.`
          : allAuthors[0] || orcid.name;

        return {
          title,
          year,
          type,
          orcid: authorString
        };
      });
    }

    function groupBy(arr, key) {
      return arr.reduce((acc, item) => {
        const val = item[key] || "n.d.";
        if (!acc[val]) acc[val] = [];
        acc[val].push(item);
        return acc;
      }, {});
    }

    function removeDuplicates(publications) {
      const seen = new Set();
      return publications.filter(pub => {
        const key = pub.title.toLowerCase().trim();
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    }

    async function showAll() {
      const container = document.getElementById("publications");
      const all = (await Promise.all(orcids.map(fetchPublications))).flat();
      const unique = removeDuplicates(all);
      const byYear = groupBy(unique, "year");

      const sortedYears = Object.keys(byYear).sort((a, b) => b - a);
      const html = sortedYears.map(year => {
        const yearPubs = byYear[year];
        const byType = groupBy(yearPubs, "type");

        return `
          <details>
            <summary>${year}</summary>
            ${Object.entries(byType).map(([type, pubs]) => `
              <h3>${type.charAt(0).toUpperCase() + type.slice(1)}</h3>
              <ul>
                ${pubs.map(p => `<li><strong>${p.title}</strong> â€“ ${p.orcid}</li>`).join("")}
              </ul>
            `).join("")}
          </details>
        `;
      }).join("");

      container.innerHTML = html;
    }

    showAll();
  </script>
</body>
</html>
