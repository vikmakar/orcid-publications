<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Team Publications</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; }
    details summary { font-size: 1.5em; cursor: pointer; margin-top: 1em; background-color: #f0f0f0; padding: 5px; }
    details[open] summary { font-weight: bold; }
    h3 { margin-top: 1em; }
    li { margin-bottom: 0.8em; }
  </style>
</head>
<body>
  <h1>Our Research Publications</h1>
  <div id="publications"></div>

  <script>
    const orcids = [
      { id: "0000-0002-5022-6150", name: "Viktorija Makarovaite" },
      { id: "0000-0002-2373-6788", name: "Campbell W. Gourlay" },
      { id: "0000-0002-5139-5765", name: "John C. Batchelor" },
      { id: "0000-0001-8977-9257", name: "Simon J. Holder" },
    ];

    async function fetchWorkDetails(orcidId, putCode) {
      const response = await fetch(`https://pub.orcid.org/v3.0/${orcidId}/work/${putCode}`, {
        headers: { Accept: "application/json" },
      });
      return response.json();
    }

    async function fetchPublications(orcid) {
      const response = await fetch(`https://pub.orcid.org/v3.0/${orcid.id}/works`, {
        headers: { Accept: "application/json" },
      });
      const data = await response.json();
      const works = data.group || [];

      const detailedWorks = await Promise.all(
        works.map(async (w) => {
          const summary = w["work-summary"][0];
          const putCode = summary["put-code"];
          const details = await fetchWorkDetails(orcid.id, putCode);

          const title = summary["title"]?.["title"]?.["value"] || "Untitled";
          const year = summary["publication-date"]?.year?.value || "n.d.";
          const type = summary["type"] || "other";
          const externalIds = summary["external-ids"]?.["external-id"] || [];
          const doi = externalIds.find(id => id["external-id-type"] === "doi")?.["external-id-value"];

          const contributors = details?.contributors?.contributor || [];
          let authorDisplay = "";
          if (contributors.length > 0) {
            const first = contributors[0]?.["credit-name"]?.value || contributors[0]?.["contributor-orcid"]?.path || "Unknown";
            authorDisplay = contributors.length > 1 ? `${first} et al.` : first;
          } else {
            authorDisplay = `${orcid.name} et al.`; // fallback
          }

          return {
            title,
            year,
            type,
            doi,
            orcid: authorDisplay
          };
        })
      );

      return detailedWorks;
    }

    function groupBy(arr, key) {
      return arr.reduce((acc, item) => {
        const val = item[key] || "n.d.";
        if (!acc[val]) acc[val] = [];
        acc[val].push(item);
        return acc;
      }, {});
    }

    async function showAll() {
      const container = document.getElementById("publications");
      const all = (await Promise.all(orcids.map(fetchPublications))).flat();

      // Remove duplicates by title
      const seen = new Set();
      const unique = all.filter(p => {
        const key = p.title.toLowerCase();
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });

      const byYear = groupBy(unique, "year");
      const sortedYears = Object.keys(byYear).sort((a, b) => b - a);
      const html = sortedYears.map(year => {
        const yearPubs = byYear[year];
        const byType = groupBy(yearPubs, "type");

        return `
          <details>
            <summary>${year}</summary>
            ${Object.entries(byType).map(([type, pubs]) => `
              <h3>${type.charAt(0).toUpperCase() + type.slice(1)}</h3>
              <ul>
                ${pubs.map(p => {
                  const titleText = p.doi
                    ? `<a href="https://doi.org/${p.doi}" target="_blank"><strong>${p.title}</strong></a>`
                    : `<strong>${p.title}</strong>`;
                  return `<li>${titleText} â€“ ${p.orcid}</li>`;
                }).join("")}
              </ul>
            `).join("")}
          </details>
        `;
      }).join("");

      container.innerHTML = html;
    }

    showAll();
  </script>
</body>
</html>
